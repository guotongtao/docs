# LVS

LVS是Linux Virtual Server的简写，意即Linux虚拟服务器，是一个虚拟的服务器集群系统。本项目在1998年5月由[章文嵩](https://baike.baidu.com/item/章文嵩/6689425)博士成立，是中国国内最早出现的自由软件项目之一。

其可用性=可用时间/（可用时间+故障恢复时间），通常用百分比来表示；99.9%表示一年的故障时间少于8小时；99.99%表示一年的故障时间少于53分钟；99.999%表示一年的故障时间小于5分钟。

## 核心组件：

lp_vs：linux内核功能模块，工作在内核，依赖该内核模块实现负载均衡功能。

lp_vs：linux内核功能模块，工作在内核，依赖该内核模块实现负载均衡功能。

ipvsadm：应用层程序，可与lp_vs通信实现对负载均衡的管理和控制。



## LVS的工作模式

lvs有四种工作模式分别为DR模式、NAT模式、TUNNEL模式、FULLNET模式。

### DR模式直接路由

原理：用户先向DNS服务器发送域名解析，DNS向用户返回解析结果此结果为代理服务器的ip地址和mac地址，用户正式向代理服务器发送请求，代理服务器接受请求后会重新分装该请求，通过预先设定的算法找出一个后端的web服务器的mac地址将数据包的目标mac地址改为此mac地址；然后在内网中广播，后端的web服务器接收数据包后会判断其目标mac地址与自己的mac地址是否相同，如果相同就会处理该数据包，处理完成后直接发送给用户；如果不相同则丢弃该数据报。

### NAT模式

原理：用户先向DNS发送域名解析，DNS将解析结构返回给用户，这里的返回结果是代理服务器上的一个虚拟ip，我们称之为vip；用户向vip发送数据报这时代理服务器会接收此数据报；然后通过预先设定的算法找出一个后端节点的真实ip我们称之为RIP，代理服务器重新封装数据包将目标ip改为RIP；web服务器收到代理服务器的转发数据包后，处理数据包，处理完成后将处理结果返回给代理服务器，再由代理服务器转发给用户。

### TUNNEL模式

这里我们不做详细介绍，TUNNEL会在原有的报文基础上添加一个新的ip报头。

### FULLNAT模式

是NAT模型的扩展代理服务器和web服务器可以不在同一网段。



## LVS的调度算法

### 轮询调度(RR)

轮询调度（Round Robin 简称'RR'）算法就是按依次循环的方式将请求调度到不同的服务器上，该算法最大的特点就是实现简单。轮询算法假设所有的服务器处理请求的能力都一样的，调度器会将所有的请求平均分配给每个真实服务器。

### 加权轮询调度(WRR)

加权轮询（Weight Round Robin 简称'WRR'）算法主要是对轮询算法的一种优化与补充，LVS会考虑每台服务器的性能，并给每台服务器添加一个权值，如果服务器A的权值为1，服务器B的权值为2，则调度器调度到服务器B的请求会是服务器A的两倍。权值越高的服务器，处理的请求越多。

### 最小连接调度(LC)

最小连接调度（Least Connections 简称'LC'）算法是把新的连接请求分配到当前连接数最小的服务器。最小连接调度是一种动态的调度算法，它通过服务器当前活跃的连接数来估计服务器的情况。调度器需要记录各个服务器已建立连接的数目，当一个请求被调度到某台服务器，其连接数加1；当连接中断或者超时，其连接数减1。

（集群系统的真实服务器具有相近的系统性能，采用最小连接调度算法可以比较好地均衡负载。)

### 加权最小连接调度(WLC)

加权最少连接（Weight Least Connections 简称'WLC'）算法是最小连接调度的超集，各个服务器相应的权值表示其处理性能。服务器的缺省权值为1，系统管理员可以动态地设置服务器的权值。加权最小连接调度在调度新连接时尽可能使服务器的已建立连接数和其权值成比例。调度器可以自动问询真实服务器的负载情况，并动态地调整其权值。

### 基于局部的最少连接(LBLC)

基于局部的最少连接调度（Locality-Based Least Connections 简称'LBLC'）算法是针对请求报文的目标IP地址的 负载均衡调度，目前主要用于Cache集群系统，因为在Cache集群客户请求报文的目标IP地址是变化的。这里假设任何后端服务器都可以处理任一请求，算法的设计目标是在服务器的负载基本平衡情况下，将相同目标IP地址的请求调度到同一台服务器，来提高各台服务器的访问局部性和Cache命中率，从而提升整个集群系统的处理能力。LBLC调度算法先根据请求的目标IP地址找出该目标IP地址最近使用的服务器，若该服务器是可用的且没有超载，将请求发送到该服务器；若服务器不存在，或者该服务器超载且有服务器处于一半的工作负载，则使用'最少连接'的原则选出一个可用的服务器，将请求发送到服务器。

### 带复制的基于局部性的最少连接(LBLCR)

带复制的基于局部性的最少连接（Locality-Based Least Connections with Replication  简称'LBLCR'）算法也是针对目标IP地址的负载均衡，目前主要用于Cache集群系统，它与LBLC算法不同之处是它要维护从一个目标IP地址到一组服务器的映射，而LBLC算法维护从一个目标IP地址到一台服务器的映射。按'最小连接'原则从该服务器组中选出一一台服务器，若服务器没有超载，将请求发送到该服务器；若服务器超载，则按'最小连接'原则从整个集群中选出一台服务器，将该服务器加入到这个服务器组中，将请求发送到该服务器。同时，当该服务器组有一段时间没有被修改，将最忙的服务器从服务器组中删除，以降低复制的程度。

### 目标地址哈希调度(DH)

目标地址哈希调度（Destination Hashing 简称'DH'）算法先根据请求的目标IP地址，作为散列键（Hash Key）从静态分配的散列表找出对应的服务器，若该服务器是可用的且并未超载，将请求发送到该服务器，否则返回空。

### 源地址哈希调度(SH)

源地址哈希调度（Source Hashing  简称'SH'）算法先根据请求的源IP地址，作为散列键（Hash Key）从静态分配的散列表找出对应的服务器，若该服务器是可用的且并未超载，将请求发送到该服务器，否则返回空。它采用的散列函数与目标地址散列调度算法的相同，它的算法流程与目标地址散列调度算法的基本相似。

### 最短的期望的延迟(SED)

最短的期望的延迟调度（Shortest Expected Delay 简称'SED'）算法基于WLC算法。举个例子吧，ABC三台服务器的权重分别为1、2、3 。那么如果使用WLC算法的话一个新请求进入时它可能会分给ABC中的任意一个。使用SED算法后会进行一个运算

A：（1+1）/1=2   B：（1+2）/2=3/2   C：（1+3）/3=4/3   就把请求交给得出运算结果最小的服务器。

### 最少队列调度(NQ)

最少队列调度（Never Queue 简称'NQ'）算法，无需队列。如果有realserver的连接数等于0就直接分配过去，不需要在进行SED运算