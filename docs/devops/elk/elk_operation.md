# ELK生产集群运维



## 集群规划

### 单一角色：职责分离

- Dedicated master eligible nodes：负责集群状态(cluster state)的管理
  - 使用低配置的CPU、RAM和磁盘
  - 从高可用&避免脑裂的角度出发(单独部署)
    - 一般生产环境中配置3台master节点
    - 一个集群只有一台活跃的主节点
      - 负责分片管理、索引创建、集群管理等操作
- Dedicated data nodes：负责数据存储及处理客户端请求
  - 使用高配置的CPU、RAM和磁盘
- Dedicated ingest nodes：负责数据处理
  - 使用高配置CPU；中等配置的RAM；低配置的磁盘
- Dedicated Coording Only Node(Client Node)
  - 配置：将Master、Data、ingest都配置成False
    - 中高配置的CPU；中高配置的RAM和低配置的磁盘
  - 生产环境中，建议为一些大的集群配置Coording Only Nodes
    - 扮演Load Balancers，降低Master和Data Nodes的负载
    - 负责搜索结果的Gather/Reduce



### Hot & Warm 架构

Hot节点使用高配置高性能磁盘

Warm节点使用低配置大容量磁盘

#### 配置Hot & Warm Architecture

- 使用Share Filtering，步骤分为以下几步
  - 标记节点（Tagging）
  - 配置索引到Hot Node
  - 配置索引到Warm节点



### 如何设计分片数

- 当分片数 > 节点数时
  - 一旦集群中有新的数据节点加入，分片就可以自动进行分配
  - 分片在重新分配时，系统就不会有downtime
- 多分片的好处：一个索引如何分布在不同的节点，多个节点可以并行执行
  - 查询可以并行执行
  - 数据写入可以分散到多个机器
- 分片数过多带来的副作用
  - Shard是Elasticsearch实现集群水平扩展的最小单位
  - 过的设置分片数会带来一些潜在的问题
    - 每个分派你是一个lucene的索引，会使用机器的资源。过多的分派你会导致额外的性能开销
      - Lucene Indices/File descriptors /RAM/CPU
      - 每次搜索的请求，需要从每个分片上获取数据
      - 分片的Meta信息由Master节点维护。过多，会增加管理的负担。经验值，控制分片总数在10W以内

### 如何确定分片数

- 从存储的物理角度看

  - 日志类应用，单个分片不要大于50G
  - 搜索类应用，单个分片不要超过20G

  > 为什么控制分片存储的大小

  - 提高update的性能
  - merge时减少所需要的资源
  - 丢失节点后，更快的恢复速度

### 如何确定副本分片数

- 副本是主分片的拷贝
  - 提高系统可用性:相应查询请求，避免数据丢失
  - 需要占用系统资源
- 对性能的影响
  - 副本会降低数据的索引速度：有几分副本就会有几倍的CPU资源消耗在索引上
  - 会减缓对主分片的查询压力，但是会消耗同样的内存资源
    - 如果机器资源充足，提高副本数量，可以提高整体查询的QPS
- 调整分片总数的设定，避免分配不均衡



### 集群容量规划





#### 硬件配置

- 合理的硬件，数据节点尽可能的使用SSD
- 搜索等性能要求高的场景，建议SSD
  - 按照1：10的比例配置内存和硬盘
- 日志类和查询并发低的场景，可以考虑使用机械硬盘存储
  - 按照1：50的比例配置内存和硬盘
- 单节点数据建议控制在2TB以内，最大不建议超过5TB
- JVM配置机器内存的一半，JVM内存配置不建议超过32G



